name: Setup Windows VNC over Tailscale

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  vnc-setup:
    runs-on: windows-latest
    steps:
      # 1. Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. Install Chocolatey if missing
      - name: Install Chocolatey
        run: |
          if (-Not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }

      # 3. Install Tailscale
      - name: Install Tailscale
        run: choco install tailscale -y

      # 4. Authenticate and start Tailscale
      - name: Start and Authenticate Tailscale
        run: |
          Start-Service Tailscale
          cd dhhd--authkey ${{ secrets.TS_AUTHKEY }} --accept-routes

      # 5. Install TightVNC server
      - name: Install TightVNC
        run: choco install tightvnc -y

      # 6. Generate 20-character password
      - name: Generate VNC Password
        id: generate_password
        run: |
          $password = -join ((48..57) + (65..90) + (97..122) | Get-Random -Count 20 | % {[char]$_})
          echo "VNC_PASSWORD=$password" >> $GITHUB_ENV

      # 7. Configure VNC server
      - name: Configure VNC Server
        run: |
          $vncPassword = $env:VNC_PASSWORD
          Write-Host "Generated VNC password: $vncPassword"
          # Set VNC password
          & "C:\Program Files\TightVNC\tvnserver.exe" -controlapp -setpassword $vncPassword
          # Start VNC server
          Start-Process "C:\Program Files\TightVNC\tvnserver.exe"

      # 8. Output Tailscale IP and VNC access info
      - name: Output VNC Access Info
        run: |
          $tailscaleIP = tailscale ip -4
          Write-Host "VNC server is accessible at $tailscaleIP:5900"
          Write-Host "Username: Windows11, Password: $env:VNC_PASSWORD"

      # 9. Maintain connection alive
      - name: Maintain Connection
        run: |
          while ($true) {
            Write-Host "Tailscale + VNC alive"
            Start-Sleep -Seconds 60
          }
